{% extends "base.html" %}

{% block title %}
    {% if testcase %}Edit Test Case{% else %}Create Test Case{% endif %} - Test Case Management
{% endblock %}

{% block nav_testcases %}active{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'test_cases:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'test_cases:testcase_list' %}">Test Cases</a></li>
        <li class="breadcrumb-item active" aria-current="page">
            {% if testcase %}Edit Test Case{% else %}Create Test Case{% endif %}
        </li>
    </ol>
</nav>
{% endblock %}

{% block page_title %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">{% if testcase %}Edit Test Case: {{ testcase.name }}{% else %}Create New Test Case{% endif %}</h1>
    <a href="{% url 'test_cases:testcase_list' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> Back to Test Cases
    </a>
</div>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            {% if testcase %}
                <i class="fas fa-edit"></i> Edit Test Case Details
            {% else %}
                <i class="fas fa-plus"></i> Test Case Information
            {% endif %}
        </h5>
    </div>
    <div class="card-body">
        {% if testcase %}
        <div class="mb-4 p-3 border-start border-4 border-primary bg-light">
            <div class="d-flex align-items-center mb-2">
                <i class="fas fa-sitemap text-primary me-2"></i>
                <h6 class="mb-0">Hierarchical Context:</h6>
            </div>
            <div class="d-flex align-items-center flex-wrap">
                <span class="badge bg-primary me-2">Project</span>
                <strong>{{ testcase.user_story.epic.project.name }}</strong>
                <i class="fas fa-angle-right mx-2"></i>
                <span class="badge bg-success me-2">Epic</span>
                <strong>{{ testcase.user_story.epic.name }}</strong>
                <i class="fas fa-angle-right mx-2"></i>
                <span class="badge bg-info me-2">User Story</span>
                <strong>{{ testcase.user_story.name }}</strong>
                <i class="fas fa-angle-right mx-2"></i>
                <span class="badge bg-warning me-2">Test Case</span>
                <strong class="ms-2">{{ testcase.name }}</strong>
            </div>
        </div>
        {% endif %}

        <form method="post" novalidate>
            {% csrf_token %}
            
            <!-- Hierarchical Selectors -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0"><i class="fas fa-sitemap"></i> Hierarchical Selection</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.project.id_for_label }}" class="form-label">{{ form.project.label }} *</label>
                                {{ form.project }}
                                <div id="project-loading" class="d-none">
                                    <small class="text-muted">
                                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                        Loading projects...
                                    </small>
                                </div>
                                {% if form.project.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.project.errors %}
                                            <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">Select the project for this test case.</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.epic.id_for_label }}" class="form-label">{{ form.epic.label }} *</label>
                                {{ form.epic }}
                                <div id="epic-loading" class="d-none">
                                    <small class="text-muted">
                                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                        Loading epics...
                                    </small>
                                </div>
                                {% if form.epic.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.epic.errors %}
                                            <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">Select the epic for this test case.</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.user_story.id_for_label }}" class="form-label">{{ form.user_story.label }} *</label>
                                {{ form.user_story }}
                                <div id="user-story-loading" class="d-none">
                                    <small class="text-muted">
                                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                        Loading user stories...
                                    </small>
                                </div>
                                {% if form.user_story.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.user_story.errors %}
                                            <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">Select the user story for this test case.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Test Case Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0"><i class="fas fa-clipboard-check"></i> Test Case Details</h6>
                </div>
                <div class="card-body">
                    <!-- Test Case Name -->
                    <div class="mb-3">
                        <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }} *</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.name.errors %}
                                    <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">Provide a clear and descriptive name for the test case.</div>
                    </div>
                    
                    <!-- Description with Rich Text Editor -->
                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                        <div id="description-editor" style="height: 150px;"></div>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.description.errors %}
                                    <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">Provide a detailed description of what this test case covers.</div>
                    </div>
                </div>
            </div>
            
            <!-- Test Execution Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0"><i class="fas fa-play-circle"></i> Test Execution Details</h6>
                </div>
                <div class="card-body">
                    <!-- Test Steps -->
                    <div class="mb-3">
                        <label for="{{ form.test_steps.id_for_label }}" class="form-label">{{ form.test_steps.label }} *</label>
                        <div id="test-steps-editor" style="height: 200px;"></div>
                        {{ form.test_steps }}
                        {% if form.test_steps.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.test_steps.errors %}
                                    <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            List the step-by-step instructions to execute this test case. Use numbered or bulleted lists for clarity.
                        </div>
                    </div>
                    
                    <!-- Expected Results -->
                    <div class="mb-3">
                        <label for="{{ form.expected_results.id_for_label }}" class="form-label">{{ form.expected_results.label }} *</label>
                        <div id="expected-results-editor" style="height: 150px;"></div>
                        {{ form.expected_results }}
                        {% if form.expected_results.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.expected_results.errors %}
                                    <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            Describe the expected outcome when the test steps are executed correctly.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Test Case Properties -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0"><i class="fas fa-cog"></i> Test Case Properties</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Status and Execution Status -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.status.id_for_label }}" class="form-label">{{ form.status.label }}</label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.status.errors %}
                                            <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">Current development status of the test case.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.execution_status.id_for_label }}" class="form-label">{{ form.execution_status.label }}</label>
                                {{ form.execution_status }}
                                {% if form.execution_status.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.execution_status.errors %}
                                            <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">Current execution status of the test case.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Priority -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.priority.id_for_label }}" class="form-label">{{ form.priority.label }}</label>
                                {{ form.priority }}
                                {% if form.priority.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.priority.errors %}
                                            <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">Set the priority level for this test case.</div>
                            </div>
                        </div>
                        
                        <!-- Automated Status -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.is_automated.id_for_label }}" class="form-label">{{ form.is_automated.label }}</label>
                                <div class="form-check">
                                    {{ form.is_automated }}
                                    <label class="form-check-label" for="{{ form.is_automated.id_for_label }}">
                                        This test case is automated
                                    </label>
                                </div>
                                {% if form.is_automated.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.is_automated.errors %}
                                            <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">Check if this test case can be or is automated.</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Assignment -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="{{ form.assigned_to.id_for_label }}" class="form-label">{{ form.assigned_to.label }}</label>
                                {{ form.assigned_to }}
                                {% if form.assigned_to.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.assigned_to.errors %}
                                            <small><i class="fas fa-exclamation-circle"></i> {{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">Assign this test case to a team member for execution.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Non-field Errors -->
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
            
            <!-- Form Actions -->
            <div class="d-flex justify-content-end gap-2 mt-4">
                <a href="{% url 'test_cases:testcase_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> Cancel
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> 
                    {% if testcase %}Update Test Case{% else %}Create Test Case{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Test Case Information Card (for edit) -->
{% if testcase %}
<div class="card mt-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-info-circle"></i> Test Case Information
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <p><strong>Project:</strong> {{ testcase.user_story.epic.project.name }}</p>
                <p><strong>Epic:</strong> {{ testcase.user_story.epic.name }}</p>
                <p><strong>User Story:</strong> {{ testcase.user_story.name }}</p>
                <p><strong>Created By:</strong> {{ testcase.created_by.get_full_name|default:testcase.created_by.username }}</p>
                <p><strong>Created Date:</strong> {{ testcase.created_date|date:"F j, Y, g:i a" }}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Status:</strong> 
                    <span class="badge bg-{% if testcase.status == 'draft' %}secondary{% elif testcase.status == 'ready' %}success{% else %}warning{% endif %}">
                        {{ testcase.get_status_display }}
                    </span>
                </p>
                <p><strong>Execution Status:</strong> 
                    <span class="badge bg-{% if testcase.execution_status == 'not_executed' %}secondary{% elif testcase.execution_status == 'passed' %}success{% elif testcase.execution_status == 'failed' %}danger{% else %}warning{% endif %}">
                        {{ testcase.get_execution_status_display }}
                    </span>
                </p>
                <p><strong>Priority:</strong> 
                    <span class="badge bg-{% if testcase.priority == 'low' %}secondary{% elif testcase.priority == 'medium' %}info{% elif testcase.priority == 'high' %}warning{% else %}danger{% endif %}">
                        {{ testcase.get_priority_display }}
                    </span>
                </p>
                <p><strong>Last Updated:</strong> {{ testcase.updated_date|date:"F j, Y, g:i a" }}</p>
                <p><strong>Last Executed:</strong> {{ testcase.last_executed|date:"F j, Y, g:i a"|default:"Never" }}</p>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_css %}
<!-- Quill Rich Text Editor CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    .ql-editor {
        min-height: 100px;
    }
    .form-control[style*="display: none"] {
        display: none !important;
    }
    .hierarchical-selector {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .priority-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    .priority-low { background-color: #6c757d; }
    .priority-medium { background-color: #17a2b8; }
    .priority-high { background-color: #ffc107; }
    .priority-critical { background-color: #dc3545; }
</style>
{% endblock %}

{% block extra_js %}
<!-- Quill Rich Text Editor JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Quill editors
    const descriptionEditor = new Quill('#description-editor', {
        theme: 'snow',
        placeholder: 'Enter test case description...',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'color': [] }, { 'background': [] }],
                ['link', 'code-block'],
                ['clean']
            ]
        }
    });

    const testStepsEditor = new Quill('#test-steps-editor', {
        theme: 'snow',
        placeholder: 'Enter step-by-step test instructions...',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'color': [] }],
                ['link', 'code-block'],
                ['clean']
            ]
        }
    });

    const expectedResultsEditor = new Quill('#expected-results-editor', {
        theme: 'snow',
        placeholder: 'Enter expected results...',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'color': [] }],
                ['link'],
                ['clean']
            ]
        }
    });

    // Set initial content from form fields
    const descriptionField = document.getElementById('{{ form.description.id_for_label }}');
    const testStepsField = document.getElementById('{{ form.test_steps.id_for_label }}');
    const expectedResultsField = document.getElementById('{{ form.expected_results.id_for_label }}');

    if (descriptionField.value) {
        descriptionEditor.root.innerHTML = descriptionField.value;
    }
    if (testStepsField.value) {
        testStepsEditor.root.innerHTML = testStepsField.value;
    }
    if (expectedResultsField.value) {
        expectedResultsEditor.root.innerHTML = expectedResultsField.value;
    }

    // Hide original textareas
    descriptionField.style.display = 'none';
    testStepsField.style.display = 'none';
    expectedResultsField.style.display = 'none';

    // Update hidden fields when editor content changes
    descriptionEditor.on('text-change', function() {
        descriptionField.value = descriptionEditor.root.innerHTML;
    });

    testStepsEditor.on('text-change', function() {
        testStepsField.value = testStepsEditor.root.innerHTML;
    });

    expectedResultsEditor.on('text-change', function() {
        expectedResultsField.value = expectedResultsEditor.root.innerHTML;
    });

    // Hierarchical dropdown functionality
    const projectSelect = document.getElementById('{{ form.project.id_for_label }}');
    const epicSelect = document.getElementById('{{ form.epic.id_for_label }}');
    const userStorySelect = document.getElementById('{{ form.user_story.id_for_label }}');
    const projectLoadingDiv = document.getElementById('project-loading');
    const epicLoadingDiv = document.getElementById('epic-loading');
    const userStoryLoadingDiv = document.getElementById('user-story-loading');
    
    // Function to show/hide loading state
    function toggleLoading(element, show) {
        if (element) {
            if (show) {
                element.classList.remove('d-none');
            } else {
                element.classList.add('d-none');
            }
        }
    }
    
    // Function to clear dropdown options
    function clearOptions(select, placeholder) {
        select.innerHTML = `<option value="">${placeholder}</option>`;
    }
    
    // Function to populate dropdown options
    function populateOptions(select, data, placeholder) {
        clearOptions(select, placeholder);
        data.forEach(function(item) {
            const option = document.createElement('option');
            option.value = item.id;
            option.textContent = item.name;
            select.appendChild(option);
        });
        // If no items are returned, add a disabled option
        if (data.length === 0) {
            const noItemsOption = document.createElement('option');
            noItemsOption.value = '';
            noItemsOption.textContent = `No ${placeholder.toLowerCase().replace('select ', '')} available`;
            noItemsOption.disabled = true;
            select.appendChild(noItemsOption);
        }
    }
    
    // Function to show error message
    function showError(parentElement, message) {
        // Remove existing error messages
        const existingError = parentElement.querySelector('.ajax-error');
        if (existingError) {
            existingError.remove();
        }
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-warning alert-dismissible fade show mt-2 ajax-error';
        errorDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        parentElement.appendChild(errorDiv);
        
        // Auto-remove error after 5 seconds
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.remove();
            }
        }, 5000);
    }
    
    // Function to handle project selection change
    function handleProjectChange() {
        const projectId = projectSelect.value;
        
        // Clear dependent dropdowns
        clearOptions(epicSelect, 'Select Epic...');
        clearOptions(userStorySelect, 'Select User Story...');
        
        if (!projectId) {
            return;
        }
        
        // Show loading state
        toggleLoading(epicLoadingDiv, true);
        epicSelect.disabled = true;
        
        // Make AJAX request to get epics for selected project
        fetch(`{% url 'test_cases:get_epics_by_project' %}?project_id=${projectId}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            populateOptions(epicSelect, data, 'Select Epic...');
            toggleLoading(epicLoadingDiv, false);
            epicSelect.disabled = false;
            // If editing and initial epic is set, trigger epic change
            {% if testcase %}
            const initialEpicId = "{{ testcase.user_story.epic.pk }}";
            if (epicSelect.querySelector(`option[value="${initialEpicId}"]`)) {
                epicSelect.value = initialEpicId;
                handleEpicChange();
            }
            {% endif %}
        })
        .catch(error => {
            console.error('Error fetching epics:', error);
            toggleLoading(epicLoadingDiv, false);
            epicSelect.disabled = false;
            showError(epicSelect.parentNode, 'Failed to load epics. Please try again or refresh the page.');
        });
    }
    
    // Function to handle epic selection change
    function handleEpicChange() {
        const epicId = epicSelect.value;
        
        // Clear dependent dropdown
        clearOptions(userStorySelect, 'Select User Story...');
        
        if (!epicId) {
            userStorySelect.disabled = true;
            return;
        }
        
        // Show loading state
        toggleLoading(userStoryLoadingDiv, true);
        userStorySelect.disabled = true;
        
        // Clear any previous errors
        const existingError = userStorySelect.parentNode.querySelector('.ajax-error');
        if (existingError) {
            existingError.remove();
        }
        
        // Make AJAX request to get user stories for selected epic
        fetch(`{% url 'test_cases:get_stories_by_epic' %}?epic_id=${epicId}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!Array.isArray(data)) {
                throw new Error('Invalid response format');
            }
            
            populateOptions(userStorySelect, data, 'Select User Story...');
            
            // If editing and initial user story is set, select it
            {% if testcase %}
            const initialUserStoryId = "{{ testcase.user_story.pk }}";
            if (initialUserStoryId && userStorySelect.querySelector(`option[value="${initialUserStoryId}"]`)) {
                userStorySelect.value = initialUserStoryId;
            }
            {% endif %}
        })
        .catch(error => {
            console.error('Error fetching user stories:', error);
            showError(userStorySelect.parentNode, 'Failed to load user stories. Please try again or refresh the page.');
            
            // If we have a test case but failed to load user stories, try to enable the user story select
            // with the current value to allow form submission
            {% if testcase %}
            const initialUserStoryId = "{{ testcase.user_story.pk }}";
            if (initialUserStoryId) {
                const option = document.createElement('option');
                option.value = initialUserStoryId;
                option.textContent = '{{ testcase.user_story.title }}';
                userStorySelect.appendChild(option);
                userStorySelect.value = initialUserStoryId;
            }
            {% endif %}
        })
        .finally(() => {
            toggleLoading(userStoryLoadingDiv, false);
            userStorySelect.disabled = false;
        });
    }
    
    // Attach event listeners
    if (projectSelect) {
        projectSelect.addEventListener('change', handleProjectChange);
    }
    
    if (epicSelect) {
        epicSelect.addEventListener('change', handleEpicChange);
    }
    
    // Initialize cascading dropdowns on page load
    function initializeDropdowns() {
        // First, ensure all dropdowns are in a clean state
        projectSelect.disabled = false;
        epicSelect.disabled = true;
        userStorySelect.disabled = true;
        
        // Clear any existing options except the first one
        clearOptions(epicSelect, 'Select Epic...');
        clearOptions(userStorySelect, 'Select User Story...');
        
        // Handle edit scenario
        {% if testcase %}
        const projectId = "{{ testcase.user_story.epic.project.pk }}";
        const epicId = "{{ testcase.user_story.epic.pk }}";
        const userStoryId = "{{ testcase.user_story.pk }}";
        
        if (projectId) {
            // Set the project and trigger the change to load epics
            projectSelect.value = projectId;
            
            // Small delay to ensure the change event is processed
            setTimeout(() => {
                // After epics are loaded, set the epic and trigger user stories load
                if (epicId) {
                    // Wait for epics to be populated
                    const checkEpic = setInterval(() => {
                        const epicOption = epicSelect.querySelector(`option[value="${epicId}"]`);
                        if (epicOption) {
                            clearInterval(checkEpic);
                            epicSelect.value = epicId;
                            
                            // After a small delay, set the user story
                            setTimeout(() => {
                                if (userStoryId) {
                                    const userStoryOption = userStorySelect.querySelector(`option[value="${userStoryId}"]`);
                                    if (userStoryOption) {
                                        userStorySelect.value = userStoryId;
                                    }
                                }
                            }, 300);
                        }
                    }, 100);
                }
            }, 300);
            
            // Trigger the initial project change
            handleProjectChange();
        }
        {% else %}
        // For new test cases, check if there are initial values in the form
        const initialProjectId = projectSelect.value;
        if (initialProjectId) {
            // If there's an initial project selected, trigger the change
            handleProjectChange();
            
            // Check for initial epic after a delay
            setTimeout(() => {
                const initialEpicId = epicSelect.value;
                if (initialEpicId) {
                    handleEpicChange();
                }
            }, 300);
        }
        {% endif %}
    }
    
    // Initialize the dropdowns when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Small delay to ensure all elements are rendered
        setTimeout(initializeDropdowns, 100);
    });

    // Form validation and submission
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        // Update hidden fields before validation
        descriptionField.value = descriptionEditor.root.innerHTML;
        testStepsField.value = testStepsEditor.root.innerHTML;
        expectedResultsField.value = expectedResultsEditor.root.innerHTML;
        
        // Required fields validation
        const nameField = document.getElementById('{{ form.name.id_for_label }}');
        const requiredFields = [
            { field: projectSelect, name: 'Project' },
            { field: epicSelect, name: 'Epic' },
            { field: userStorySelect, name: 'User Story' },
            { field: nameField, name: 'Test Case Name' },
            { field: testStepsField, name: 'Test Steps' },
            { field: expectedResultsField, name: 'Expected Results' }
        ];
        
        // Reset previous validations
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        document.querySelectorAll('.ajax-error').forEach(el => el.remove());
        
        // Validate all required fields
        let firstInvalidField = null;
        let isValid = true;
        
        requiredFields.forEach(({field, name}) => {
            if (field && (!field.value || !field.value.trim())) {
                field.classList.add('is-invalid');
                const errorMsg = document.createElement('div');
                errorMsg.className = 'invalid-feedback';
                errorMsg.textContent = `${name} is required`;
                
                const existingError = field.parentNode.querySelector('.invalid-feedback');
                if (!existingError) {
                    field.parentNode.appendChild(errorMsg);
                }
                
                if (!firstInvalidField) {
                    firstInvalidField = field;
                }
                isValid = false;
            }
        });
        
        // If validation fails, prevent form submission
        if (!isValid) {
            e.preventDefault();
            if (firstInvalidField) {
                firstInvalidField.focus();
                firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Show error message at the top of the form
                const errorAlert = document.createElement('div');
                errorAlert.className = 'alert alert-danger';
                errorAlert.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Please fill in all required fields marked with *
                `;
                const formGroup = form.querySelector('.card-body');
                if (formGroup) {
                    formGroup.insertBefore(errorAlert, formGroup.firstChild);
                }
                
                // Auto-remove error after 5 seconds
                setTimeout(() => {
                    errorAlert.remove();
                }, 5000);
            }
            return false;
        }
        
        // If we get here, all validations passed
        // Show loading state on submit button
        const submitButton = this.querySelector('button[type="submit"]');
        if (submitButton) {
            const originalText = submitButton.innerHTML;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
            submitButton.disabled = true;
            
            // Re-enable button after 10 seconds as fallback
            setTimeout(() => {
                if (submitButton.disabled) {
                    submitButton.innerHTML = originalText;
                    submitButton.disabled = false;
                }
            }, 10000);
        }
    });

    // Priority indicator
    const prioritySelect = document.getElementById('{{ form.priority.id_for_label }}');
    if (prioritySelect) {
        function updatePriorityIndicator() {
            const priority = prioritySelect.value;
            const label = prioritySelect.parentNode.querySelector('label');
            
            // Remove existing indicators
            const existingIndicator = label.querySelector('.priority-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            // Add new indicator
            if (priority) {
                const indicator = document.createElement('span');
                indicator.className = `priority-indicator priority-${priority}`;
                label.insertBefore(indicator, label.firstChild);
            }
        }
        
        prioritySelect.addEventListener('change', updatePriorityIndicator);
        updatePriorityIndicator(); // Initial call
    }

    // Auto-focus on the first form field
    const firstInput = document.querySelector('form select:not([disabled]), form input:not([type="hidden"]):not([disabled])');
    if (firstInput) {
        firstInput.focus();
    }

    // Character count for name field
    const nameField = document.getElementById('{{ form.name.id_for_label }}');
    if (nameField) {
        const maxLength = 200; // Assuming max length from model
        const charCountDiv = document.createElement('div');
        charCountDiv.className = 'form-text text-end';
        charCountDiv.id = nameField.id + '_count';
        nameField.parentNode.appendChild(charCountDiv);
        
        function updateCharCount() {
            const remaining = maxLength - nameField.value.length;
            charCountDiv.textContent = `${nameField.value.length}/${maxLength} characters`;
            charCountDiv.className = remaining < 20 ? 'form-text text-end text-warning' : 'form-text text-end text-muted';
        }
        
        nameField.addEventListener('input', updateCharCount);
        updateCharCount();
    }

    // Enhanced validation feedback
    document.querySelectorAll('input, select, textarea').forEach(field => {
        field.addEventListener('blur', function() {
            if (this.hasAttribute('required') && !this.value.trim()) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
        
        field.addEventListener('input', function() {
            if (this.classList.contains('is-invalid') && this.value.trim()) {
                this.classList.remove('is-invalid');
            }
        });
    });
});
</script>
{% endblock %}