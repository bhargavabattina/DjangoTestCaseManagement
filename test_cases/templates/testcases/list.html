    document.getElementById('epic').addEventListener('change', function() {
        const selectedEpic = this.value;
        const storySelect = document.getElementById('story');
        
        // Filter stories based on selected epic
        Array.from(storySelect.options).forEach(option => {
            if (option.value === '') {
                option.style.display = 'block';
            } else {
                const epicId = option.getAttribute('data-epic');
                option.style.display = (!selectedEpic || epicId === selectedEpic) ? 'block' : 'none';
            }
        });
        
        // Reset story selection if it doesn't belong to selected epic
        if (selectedEpic && storySelect.value) {
            const selectedStoryOption = storySelect.options[storySelect.selectedIndex];
            const storyEpicId = selectedStoryOption.getAttribute('data-epic');
            if (storyEpicId !== selectedEpic) {
                storySelect.value = '';
            }
        }
        
        this.form.submit();
    });
    
    // Story dropdown change handler
    document.getElementById('story').addEventListener('change', function() {
        this.form.submit();
    });
    
    // Bulk actions functionality
    const bulkActionsBtn = document.getElementById('bulk-actions-btn');
    const bulkActionsPanel = document.getElementById('bulk-actions-panel');
    const testcaseCheckboxes = document.querySelectorAll('.testcase-checkbox');
    const selectAllCheckbox = document.getElementById('select-all');
    const headerSelectAllCheckbox = document.getElementById('header-select-all');
    const selectedCountSpan = document.getElementById('selected-count');
    
    // Function to update selected count and bulk actions visibility
    function updateBulkActionsState() {
        const checkedBoxes = document.querySelectorAll('.testcase-checkbox:checked');
        const count = checkedBoxes.length;
        
        selectedCountSpan.textContent = count + ' item' + (count !== 1 ? 's' : '') + ' selected';
        
        if (count > 0) {
            bulkActionsBtn.style.display = 'inline-block';
        } else {
            bulkActionsBtn.style.display = 'none';
            bulkActionsPanel.style.display = 'none';
        }
        
        // Update select-all checkboxes state
        const allChecked = count === testcaseCheckboxes.length && count > 0;
        const someChecked = count > 0 && count < testcaseCheckboxes.length;
        
        selectAllCheckbox.checked = allChecked;
        headerSelectAllCheckbox.checked = allChecked;
        selectAllCheckbox.indeterminate = someChecked;
        headerSelectAllCheckbox.indeterminate = someChecked;
    }
    
    // Individual checkbox change handlers
    testcaseCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActionsState);
    });
    
    // Select all functionality
    function toggleAllCheckboxes(checked) {
        testcaseCheckboxes.forEach(checkbox => {
            checkbox.checked = checked;
        });
        updateBulkActionsState();
    }
    
    selectAllCheckbox.addEventListener('change', function() {
        toggleAllCheckboxes(this.checked);
    });
    
    headerSelectAllCheckbox.addEventListener('change', function() {
        toggleAllCheckboxes(this.checked);
    });
    
    // Bulk actions button click handler
    bulkActionsBtn.addEventListener('click', function() {
        if (bulkActionsPanel.style.display === 'none' || !bulkActionsPanel.style.display) {
            bulkActionsPanel.style.display = 'block';
        } else {
            bulkActionsPanel.style.display = 'none';
        }
    });
    
    // Cancel bulk actions
    document.getElementById('cancel-bulk-actions').addEventListener('click', function() {
        bulkActionsPanel.style.display = 'none';
        testcaseCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        selectAllCheckbox.checked = false;
        headerSelectAllCheckbox.checked = false;
        updateBulkActionsState();
    });
    
    // Apply bulk actions
    document.getElementById('apply-bulk-actions').addEventListener('click', function() {
        const checkedBoxes = document.querySelectorAll('.testcase-checkbox:checked');
        const bulkStatus = document.getElementById('bulk-status').value;
        const bulkExecutionStatus = document.getElementById('bulk-execution-status').value;
        const bulkPriority = document.getElementById('bulk-priority').value;
        
        if (checkedBoxes.length === 0) {
            alert('Please select at least one test case.');
            return;
        }
        
        if (!bulkStatus && !bulkExecutionStatus && !bulkPriority) {
            alert('Please select at least one action to apply.');
            return;
        }
        
        if (confirm(`Apply changes to ${checkedBoxes.length} selected test case(s)?`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "test_cases:testcase_list" %}';
            
            // Add CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
            
            // Add bulk action indicator
            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'bulk_action';
            actionInput.value = 'true';
            form.appendChild(actionInput);
            
            // Add selected test case IDs
            checkedBoxes.forEach(checkbox => {
                const idInput = document.createElement('input');
                idInput.type = 'hidden';
                idInput.name = 'selected_testcases';
                idInput.value = checkbox.value;
                form.appendChild(idInput);
            });
            
            // Add bulk action values
            if (bulkStatus) {
                const statusInput = document.createElement('input');
                statusInput.type = 'hidden';
                statusInput.name = 'bulk_status';
                statusInput.value = bulkStatus;
                form.appendChild(statusInput);
            }
            
            if (bulkExecutionStatus) {
                const execStatusInput = document.createElement('input');
                execStatusInput.type = 'hidden';
                execStatusInput.name = 'bulk_execution_status';
                execStatusInput.value = bulkExecutionStatus;
                form.appendChild(execStatusInput);
            }
            
            if (bulkPriority) {
                const priorityInput = document.createElement('input');
                priorityInput.type = 'hidden';
                priorityInput.name = 'bulk_priority';
                priorityInput.value = bulkPriority;
                form.appendChild(priorityInput);
            }
            
            document.body.appendChild(form);
            form.submit();
        }
    });
    
    // Export functionality
    document.getElementById('export-btn').addEventListener('click', function() {
        try {
            // Get current filter parameters
            const urlParams = new URLSearchParams(window.location.search);
            const exportParams = new URLSearchParams();
            
            // Preserve current filters in export
            if (urlParams.get('project')) exportParams.set('project', urlParams.get('project'));
            if (urlParams.get('epic')) exportParams.set('epic', urlParams.get('epic'));
            if (urlParams.get('story')) exportParams.set('story', urlParams.get('story'));
            if (urlParams.get('search')) exportParams.set('search', urlParams.get('search'));
            
            // Add export parameter
            exportParams.set('export', 'excel');
            
            // Create download link
            const exportUrl = window.location.pathname + '?' + exportParams.toString();
            const link = document.createElement('a');
            link.href = exportUrl;
            link.download = 'testcases_export.xlsx';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch (error) {
            console.error('Export error:', error);
            alert('An error occurred during export. Please try again.');
        }
    });
    
    // Initialize bulk actions state
    updateBulkActionsState();
    
    // Modal functionality enhancements
    document.addEventListener('DOMContentLoaded', function() {
        // Ensure all modals work properly
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            modal.addEventListener('shown.bs.modal', function() {
                // Focus on first input if available
                const firstInput = modal.querySelector('input:not([type="hidden"]), select, textarea');
                if (firstInput) {
                    firstInput.focus();
                }
            });
        });
        
        // Handle form submissions with validation
        const forms = document.querySelectorAll('form[method="post"]');
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                // Check for required fields
                const requiredFields = form.querySelectorAll('[required]');
                let hasErrors = false;
                
                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        field.classList.add('is-invalid');
                        hasErrors = true;
                    } else {
                        field.classList.remove('is-invalid');
                    }
                });
                
                if (hasErrors) {
                    e.preventDefault();
                    alert('Please fill in all required fields.');
                    return false;
                }
            });
        });
        
        // Auto-dismiss alerts after 5 seconds
        const alerts = document.querySelectorAll('.alert:not(.alert-permanent)');
        alerts.forEach(alert => {
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.style.opacity = '0';
                    setTimeout(() => {
                        if (alert.parentNode) {
                            alert.remove();
                        }
                    }, 300);
                }
            }, 5000);
        });
    });
</script>
{% endblock %}